#!/usr/bin/env python
# coding=utf-8

""" reference: http://dola.xinfan.org/?p=282 """

import os
import sys
import zipfile
import chardet


def to_utf8(string):
    enc = chardet.detect(string)['encoding']
    if enc.lower() == 'gb2312':
        enc = 'gbk'
    return unicode(string, enc).encode('utf8')


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print 'python %s zipfilename' % sys.argv[0]
    else:
        with zipfile.ZipFile(sys.argv[1]) as zf:
            nlist = zf.namelist()
            for n in sorted(nlist):
                m = to_utf8(n)
                if m.endswith('/'):
                    os.makedirs(m)
                else:
                    with open(m, 'wb') as f:
                        f.write(zf.read(n))
